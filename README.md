Cleaned up version of the code
